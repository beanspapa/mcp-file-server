# MCP 서버 보안 가이드

## 1. 보안 개요

MCP 서버의 보안 구현은 선택적(OPTIONAL)이지만, 특히 파일 시스템 접근이나 외부 시스템 연동과 같은 작업을 수행하는 서버에서는 강력히 권장됩니다. 이 문서는 `mcp-file-server`와 같이 파일 시스템과 상호작용하는 서버를 중심으로 실질적인 보안 고려사항과 구현 가이드를 제공합니다.

### 1.1 보안의 목표

- **데이터 보호**: 서버가 접근하는 파일 및 전송되는 데이터의 기밀성 및 무결성 유지.
- **접근 제어**: 허용된 클라이언트 및 경로에 대해서만 파일 시스템 접근 및 도구 실행 허용. (`allowedDirectories`, `allowedExtensions` 등)
- **서비스 가용성**: 악의적인 요청으로부터 서버 보호 (입력값 검증, 자원 제한 등).
- **통신 보안**: 클라이언트와 서버 간 통신 채널 보안 (HTTPS).
- **감사 추적**: 보안 관련 이벤트(접근 시도, 오류 등) 기록 및 추적.

### 1.2 주요 보안 위협 (파일 서버 중심)

- **Path Traversal (경로 조작)**: 사용자가 제공한 경로(`../`, 절대 경로 등)를 조작하여 허용되지 않은 디렉토리의 파일에 접근하거나 수정하려는 시도.
- **Command Injection (명령어 주입)**: 도구의 입력 파라미터를 통해 악의적인 셸 명령어를 주입하여 서버에서 임의의 코드를 실행하려는 시도 (만약 도구가 시스템 명령어를 실행한다면).
- **Denial of Service (DoS)**: 비정상적으로 크거나 많은 요청을 보내 서버 리소스를 고갈시키려는 시도.
- **Data Leakage**: 오류 메시지나 로그를 통해 민감한 내부 정보(파일 경로, 설정 등)가 노출되는 경우.
- **Insecure Communication**: 암호화되지 않은 HTTP 통신을 사용하여 중간에서 데이터가 탈취되거나 변조되는 경우.

## 2. 인증 및 통신 보안

### 2.1 통신 채널 보안 (HTTPS)

- **필수 사항**: 클라이언트와 MCP 서버 간의 모든 통신은 **HTTPS(TLS/SSL)**를 통해 암호화되어야 합니다. 이는 중간자 공격(Man-in-the-middle)으로부터 전송되는 데이터(요청 파라미터, 결과, 민감 정보 등)를 보호하는 가장 기본적인 단계입니다.
- **구현**: 서버 프레임워크(예: Node.js의 `https`, `express`와 TLS 설정)를 사용하여 HTTPS를 활성화하고, 유효한 SSL/TLS 인증서를 사용해야 합니다.

### 2.2 클라이언트 인증 (선택적)

- **단순 인증**: 간단한 시나리오에서는 미리 공유된 API 키 또는 Bearer 토큰을 HTTPS 헤더(`Authorization` 헤더 등)를 통해 전송하고 서버에서 검증하는 방식을 사용할 수 있습니다. 이 방식은 HTTPS가 보장되어야 안전합니다.
- **고급 인증 (OAuth 등)**: 더 복잡한 사용자 인증 및 권한 부여가 필요한 경우, OAuth 2.1과 같은 표준 프로토콜 도입을 고려할 수 있습니다. 이는 일반적으로 별도의 인증 서버(Identity Provider)와 연동하여 구현됩니다. `mcp-file-server`와 같은 단순 서버에서는 과도할 수 있으며, 필요에 따라 적용합니다.
- **인증 정보 보호**: 어떤 방식을 사용하든, API 키나 토큰과 같은 인증 정보는 코드나 설정 파일에 하드코딩하지 않고, 안전한 방법(환경 변수, 보안 저장소)으로 관리해야 합니다.

## 3. 접근 제어 (Authorization)

### 3.1 설정 기반 접근 제어 (`mcp-file-server` 핵심)

- **`allowedDirectories`**: 서버가 접근할 수 있는 루트 디렉토리 목록을 명시적으로 제한합니다. `FileService`와 같은 모듈은 모든 파일 접근 시도 전에 요청된 경로가 이 목록 내의 디렉토리에 속하는지 **반드시 검증**해야 합니다. (Path Traversal 방지 포함)
- **`allowedExtensions`**: 접근 가능한 파일의 확장자를 제한하여 특정 유형의 파일(예: `.txt`, `.json`, `.md`)만 읽거나 쓰도록 강제합니다. 실행 파일(`.exe`, `.sh`)이나 설정 파일(`.env`) 등 민감한 파일 유형 접근을 차단하는 데 중요합니다.
- **구현 참조**: `FileService`의 `validateAndResolvePath` 함수 구현 예시(`02-core-features/resources.md`)를 참조하여 경로 정규화, 절대 경로 변환, `startsWith`를 이용한 디렉토리 포함 여부 확인, 확장자 검사 로직을 철저히 구현해야 합니다.

### 3.2 도구별 접근 제어 (선택적)

- 특정 도구의 실행 권한을 클라이언트별 또는 역할별로 제어해야 하는 경우, 인증 시스템과 연동하여 도구 실행 전 권한 검증 로직을 추가할 수 있습니다. `ToolManager`의 `executeTool` 메서드 내에서 이러한 검사를 수행할 수 있습니다.

## 4. 입력 검증 및 처리

### 4.1 핵심 원칙: 신뢰할 수 없는 입력

- 클라이언트, LLM, 또는 외부 시스템에서 오는 **모든 입력은 신뢰할 수 없다**고 가정하고 검증해야 합니다.

### 4.2 주요 검증 영역

- **파일 경로**:
  - **Path Traversal 방지**: `../`, 절대 경로, 심볼릭 링크 등을 이용한 경로 조작 시도를 탐지하고 차단해야 합니다. (`FileService`의 역할)
  - **Null Byte Injection 방지**: 경로 문자열에 Null byte (`\0`)가 포함되어 경로 검증 로직을 우회하는 것을 방지해야 합니다.
  - **문자 인코딩**: 유효하지 않거나 예상치 못한 문자 인코딩으로 인한 문제를 방지합니다.
- **도구 파라미터**:
  - **타입 및 형식 검증**: JSON Schema 등을 사용하여 도구 입력 파라미터의 타입, 형식, 필수 여부를 엄격하게 검증합니다. (`ToolManager`의 역할)
  - **값 범위 검증**: 숫자 파라미터의 경우 허용 가능한 최소/최대값을 검증합니다. 문자열 파라미터의 경우 최대 길이를 제한합니다.
  - **Injection 방지**:
    - **Command Injection**: 시스템 명령어를 실행하는 도구의 경우, 사용자 입력을 명령어 문자열에 직접 삽입하지 않고, 안전한 실행 함수(예: Node.js의 `child_process.execFile`)를 사용하거나 입력을 엄격하게 이스케이프/필터링해야 합니다.
    - **SQL Injection 등**: 만약 도구가 데이터베이스와 상호작용한다면, 해당 컨텍스트에 맞는 Injection 방지 기법(Prepared Statement 등)을 사용해야 합니다.
- **URI 및 URL**: 외부 리소스를 참조하는 경우, URI/URL 형식이 유효한지, 예상된 스키마(예: `http`, `https`)인지, SSRF(Server-Side Request Forgery) 공격을 방지하기 위해 허용된 도메인인지 등을 검증합니다.

### 4.3 에러 처리 및 정보 노출

- **민감 정보 필터링**: 오류 메시지에 스택 트레이스 전체, 내부 파일 경로, 설정값 등 민감한 정보가 포함되지 않도록 주의해야 합니다. 클라이언트에게는 일반적인 오류 메시지와 고유 오류 ID(로깅 추적용) 정도만 반환하는 것이 좋습니다.
- **일관된 오류 응답**: 오류 유형에 따라 다른 상세 정보를 노출하면 공격자에게 시스템 내부 구조에 대한 힌트를 줄 수 있습니다. 가능한 한 일관된 형식의 오류 응답을 유지합니다.

## 5. 데이터 보호

### 5.1 전송 중 데이터 보호 (HTTPS)

- 위에서 강조했듯이, 클라이언트-서버 간 통신은 **반드시 HTTPS**를 사용해야 합니다.

### 5.2 저장 데이터 보호 (Encryption at Rest)

- 서버가 저장하는 파일 자체의 암호화는 일반적으로 운영 체제 수준(BitLocker, FileVault 등)이나 디스크/볼륨 암호화, 또는 데이터베이스의 암호화 기능을 통해 처리됩니다. MCP 서버 자체에서 파일 암호화를 구현하는 것은 복잡하며, 특별한 요구사항이 없는 한 권장되지 않습니다.
- **설정 정보 보호**: API 키, 비밀번호 등 민감한 설정 정보는 파일에 평문으로 저장하지 않고, 환경 변수나 보안 관리 도구(Vault 등)를 통해 안전하게 관리해야 합니다.

## 6. 감사 로깅 및 모니터링

### 6.1 로깅 대상

- **인증 시도**: 성공 및 실패한 로그인 시도.
- **접근 제어 결정**: 허용/거부된 파일 접근 시도 (요청 경로, 검증 결과 포함).
- **도구 실행**: 호출된 도구 이름, 파라미터(민감 정보 제외), 실행 결과(성공/실패).
- **구성 변경**: `server/config`를 통한 설정 변경 시도 및 결과.
- **중요 오류**: Path Traversal 시도 감지, 입력 검증 실패, Command Injection 시도 의심 등 보안 관련 오류.

### 6.2 로그 관리

- **구조화된 로깅**: JSON 형식 등으로 로그를 구조화하여 분석 및 모니터링 도구와의 연동을 용이하게 합니다.
- **로그 레벨**: `03-optimization.md`에서 설명된 표준 로그 레벨을 사용하여 로그의 중요도를 구분합니다. 보안 관련 이벤트는 `WARN`, `ERROR`, `CRITICAL` 등의 레벨을 적절히 사용합니다.
- **로그 저장 및 보호**: 로그 파일 자체에 대한 접근 제어를 설정하고, 필요시 로그를 중앙 집중식 로그 관리 시스템으로 전송하여 안전하게 보관하고 분석합니다.
- **개인 정보 보호**: 로그에 개인 식별 정보(PII)나 기타 민감 정보가 포함되지 않도록 주의합니다.

### 6.3 모니터링

- **로그 분석**: 중앙 로그 관리 시스템이나 APM 도구를 사용하여 비정상적인 활동 패턴(예: 짧은 시간에 많은 접근 거부 로그, 특정 IP에서의 반복적인 실패 등)을 탐지합니다.
- **알림**: 특정 보안 이벤트(예: Path Traversal 시도 감지, 중요 설정 변경) 발생 시 관리자에게 알림을 보내도록 설정합니다.

## 7. 보안 정책 및 절차

- **최소 권한 원칙**: 서버 프로세스는 작업을 수행하는 데 필요한 최소한의 파일 시스템 권한만 가져야 합니다.
- **의존성 관리**: 사용하는 라이브러리(npm 패키지 등)의 보안 취약점을 정기적으로 확인하고 업데이트합니다. (`npm audit` 등)
- **보안 설정 관리**: `allowedDirectories`, `allowedExtensions`와 같은 보안 관련 설정은 안전하게 관리하고, 변경 시 적절한 검토 및 로깅 절차를 따릅니다.
- **정기적인 검토**: 보안 설정 및 코드를 정기적으로 검토하여 잠재적인 취약점을 식별하고 개선합니다.

## 8. 다음 단계

이 문서를 통해 MCP 서버, 특히 파일 기반 서버의 실질적인 보안 구현 방법을 이해했다면, 다음 문서들을 통해 다른 측면을 학습할 수 있습니다:

1.  [성능 최적화 가이드](03-optimization.md)
2.  [핵심 기능 가이드](02-core-features/overview.md)
3.  [소개 문서](01-introduction.md)
